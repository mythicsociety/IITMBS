<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2.5: Max of Derived Metrics in a Single Iteration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .sidebar-link.active {
            background-color: #e0f2fe; /* sky-100 */
            color: #0c4a6e; /* sky-900 */
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        .quiz-option.correct {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
        }
        .quiz-option.incorrect {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }
        .feedback {
            display: none;
            padding: 0.75rem;
            margin-top: 0.75rem;
            border-radius: 0.5rem;
        }
        .feedback.correct {
            display: block;
            background-color: #f0fdf4; /* green-50 */
            color: #15803d; /* green-800 */
        }
        .feedback.incorrect {
            display: block;
            background-color: #fef2f2; /* red-50 */
            color: #b91c1c; /* red-800 */
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Mobile Header with Hamburger Menu -->
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40 lg:hidden flex items-center justify-between p-4">
        <h1 class="text-lg font-bold text-sky-800">Learning Guide</h1>
        <button id="hamburger-btn" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w_3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <div class="flex">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-white w-64 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:sticky lg:top-0 h-screen transition-transform duration-300 ease-in-out z-50 shadow-lg lg:shadow-none border-r border-slate-200">
            <div class="p-6">
                <h2 class="text-xl font-bold text-sky-800 mb-6">L2.5: Max of Derived Metrics</h2>
                <nav>
                    <ul id="nav-links" class="space-y-2">
                        <li><a href="#intro" class="sidebar-link block px-4 py-2 rounded-md text-slate-600 hover:bg-sky-50 transition-colors">Introduction</a></li>
                        <li><a href="#challenge" class="sidebar-link block px-4 py-2 rounded-md text-slate-600 hover:bg-sky-50 transition-colors">A Deeper Question</a></li>
                        <li><a href="#solution" class="sidebar-link block px-4 py-2 rounded-md text-slate-600 hover:bg-sky-50 transition-colors">The "Post-Iteration" Calculation</a></li>
                        <li><a href="#interactive-sim" class="sidebar-link block px-4 py-2 rounded-md text-slate-600 hover:bg-sky-50 transition-colors">Interactive Simulator</a></li>
                        <li><a href="#quiz" class="sidebar-link block px-4 py-2 rounded-md text-slate-600 hover:bg-sky-50 transition-colors">Knowledge Check</a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-6 md:p-10 lg:p-12 bg-slate-50 min-h-screen lg:h-screen lg:overflow-y-auto">
            <div class="max-w-4xl mx-auto">

                <!-- Introduction Section -->
                <section id="intro" class="mb-12">
                    <h2 class="text-3xl font-bold text-sky-900 mb-4 border-b-2 border-sky-200 pb-2">Getting More Meaning from Our Data</h2>
                    <p class="text-lg text-slate-700 mb-4">
                        We've learned how to efficiently find the maximum value in a dataset, even when we have to dynamically create counters for unknown categories. But sometimes, the most interesting "maximum" isn't a direct count or sum.
                    </p>
                    <p class="text-lg text-slate-700">
                        Often, the most valuable insights come from <strong>derived metrics</strong>—values we calculate *after* processing our raw data, like averages. This section explores how we can use the data gathered in a single iteration to answer more complex questions.
                    </p>
                </section>

                <!-- The Challenge Section -->
                <section id="challenge" class="mb-12">
                    <h2 class="text-3xl font-bold text-sky-900 mb-4 border-b-2 border-sky-200 pb-2">A Deeper Question: Who's Really the "Best" Shop?</h2>
                    <p class="text-lg text-slate-700 mb-4">
                        In our last exercise, we found the shop with the most bills. "SV Stores" won with 15 bills. But does that really make it the most successful shop?
                    </p>
                    <p class="text-lg text-slate-700 mb-4">
                        What if "Big Bazaar" had only 6 bills, but each bill was for a very large amount? A better metric for success might be the <strong>total revenue</strong> (the sum of all bill amounts) or the <strong>average revenue per bill</strong>.
                    </p>
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg my-6">
                        <p class="font-semibold">The Core Problem:</p>
                        <p>We can't calculate the average revenue for a shop until we have processed *all* of its bills to get the final total revenue and the final total bill count. This calculation must happen *after* the main iteration is complete.</p>
                    </div>
                </section>

                <!-- The Solution Section -->
                <section id="solution" class="mb-12">
                    <h2 class="text-3xl font-bold text-sky-900 mb-4 border-b-2 border-sky-200 pb-2">The "Post-Iteration" Calculation</h2>
                    <p class="text-lg text-slate-700 mb-4">
                        The solution is to expand the data we collect during our single iteration. Instead of just one counter per shop, we'll maintain two:
                    </p>
                    <ul class="list-disc list-inside space-y-4 text-lg text-slate-700">
                        <li>
                            A counter for the <strong>total number of bills</strong> (e.g., `sv_stores_count`).
                        </li>
                        <li>
                            A variable to sum the <strong>total revenue</strong> (e.g., `sv_stores_revenue`).
                        </li>
                    </ul>
                     <div class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg my-6">
                        <h4 class="font-semibold">The Two-Step Process:</h4>
                        <ol class="list-decimal list-inside mt-2">
                            <li><strong>Step 1: Single Iteration.</strong> As we process each bill, we identify the shop. We increment its bill counter AND add the bill's amount to its total revenue variable. We can still find the shop with the max *total revenue* during this pass.</li>
                            <li><strong>Step 2: Final Calculation.</strong> After the loop is finished, we have the final totals for every shop. We can then perform a simple calculation for each one: `average = total_revenue / total_bills`. Finally, we compare these few calculated averages to find the ultimate winner.</li>
                        </ol>
                    </div>
                    <p class="text-lg text-slate-700">
                        This powerful pattern allows us to answer complex questions by gathering all necessary raw data in one efficient pass and then performing final calculations on the summarized results.
                    </p>
                </section>

                <!-- Interactive Simulator Section -->
                <section id="interactive-sim" class="mb-12">
                    <h2 class="text-3xl font-bold text-sky-900 mb-4 border-b-2 border-sky-200 pb-2">⚙️ Shop Performance Simulator</h2>
                    <p class="text-lg text-slate-700 mb-6">
                        This simulator processes bills with random amounts. During the iteration, it tracks the shop with the highest **Total Revenue**. After finishing, it calculates the **Average Revenue** for each shop and highlights the winner in that category. Notice how the "best" shop can change depending on the metric!
                    </p>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-center space-x-4 mb-4">
                            <button id="start-sim-btn" class="px-6 py-2 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-colors">Start</button>
                            <button id="reset-sim-btn" class="px-6 py-2 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-75 transition-colors">Reset</button>
                        </div>
                        <div id="sim-status" class="text-center font-semibold text-lg h-8 mb-4 text-slate-700">Press 'Start' to begin.</div>
                         <div class="flex flex-col md:flex-row justify-around items-start space-y-6 md:space-y-0 md:space-x-6">
                            <div class="flex-1 text-center">
                                <h4 class="font-bold mb-2">Current Bill</h4>
                                <div id="current-bill-display" class="w-48 mx-auto h-24 bg-white rounded-lg shadow-lg border-2 border-sky-400 flex flex-col justify-center items-center transition-all duration-300 p-2">
                                    <span id="current-bill-shop" class="text-2xl font-bold text-sky-800">...</span>
                                    <span id="current-bill-amount" class="text-xl text-slate-600"> </span>
                                </div>
                                <h4 class="font-bold mt-6 mb-2">Max Total Revenue</h4>
                                <div id="max-revenue-display" class="w-48 mx-auto p-2 bg-white rounded-lg shadow-lg border-2 border-amber-400 flex flex-col justify-center items-center">
                                     <span id="max-revenue-shop" class="text-lg font-bold text-amber-700">None</span>
                                     <span id="max-revenue-value" class="text-2xl font-bold text-amber-600">₹0</span>
                                </div>
                            </div>
                            <div class="flex-1 text-center">
                                <h4 class="font-bold mb-2">Shop Performance Data</h4>
                                <div id="shop-counts-container" class="space-y-2 p-4 bg-slate-100 rounded-lg min-h-[16rem]">
                                    <!-- Data will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Quiz Section -->
                <section id="quiz">
                    <h2 class="text-3xl font-bold text-sky-900 mb-4 border-b-2 border-sky-200 pb-2">🧠 Knowledge Check</h2>
                    <p class="text-lg text-slate-700 mb-8">
                        Test your knowledge on calculating derived metrics.
                    </p>
                    <div id="quiz-container" class="space-y-8"></div>
                </section>

            </div>
        </main>
    </div>

    <script>
        // --- Sidebar and Scroll Logic ---
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const navLinks = document.getElementById('nav-links');

        hamburgerBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
            }
        });
        
        const sections = document.querySelectorAll('section');
        const links = document.querySelectorAll('.sidebar-link');
        mainContent.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                if (mainContent.scrollTop >= section.offsetTop - 100) {
                    current = section.getAttribute('id');
                }
            });
            links.forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === `#${current}`);
            });
        });

        // --- Interactive Simulator Logic ---
        const startSimBtn = document.getElementById('start-sim-btn');
        const resetSimBtn = document.getElementById('reset-sim-btn');
        const simStatus = document.getElementById('sim-status');
        const currentBillShopEl = document.getElementById('current-bill-shop');
        const currentBillAmountEl = document.getElementById('current-bill-amount');
        const maxRevenueShopEl = document.getElementById('max-revenue-shop');
        const maxRevenueValueEl = document.getElementById('max-revenue-value');
        const shopCountsContainer = document.getElementById('shop-counts-container');
        
        const shops = ["SV Stores", "Big Bazaar", "Sun General"];
        let bills = [];
        let simInterval;

        function generateBills() {
            bills = Array.from({length: 12}, () => {
                const shop = shops[Math.floor(Math.random() * shops.length)];
                const amount = shop === "Big Bazaar" ? Math.floor(Math.random() * 2000) + 1000 : Math.floor(Math.random() * 800) + 100;
                return { shop, amount };
            });
        }

        function resetSimulator() {
            clearInterval(simInterval);
            generateBills();
            simStatus.textContent = "Press 'Start' to begin.";
            currentBillShopEl.textContent = '...';
            currentBillAmountEl.textContent = '';
            maxRevenueShopEl.textContent = 'None';
            maxRevenueValueEl.textContent = '₹0';
            shopCountsContainer.innerHTML = '<p class="text-slate-400">No data yet.</p>';
            startSimBtn.disabled = false;
        }

        function renderShopData(shopData, highlightedShop = null, showAverage = false) {
            shopCountsContainer.innerHTML = '';
            const sortedShops = Object.keys(shopData).sort();

            let maxAvg = -1;
            let maxAvgShop = '';
            if (showAverage) {
                 sortedShops.forEach(shop => {
                    const avg = shopData[shop].revenue / shopData[shop].count;
                    if (avg > maxAvg) {
                        maxAvg = avg;
                        maxAvgShop = shop;
                    }
                });
            }

            sortedShops.forEach(shop => {
                const data = shopData[shop];
                const isUpdated = shop === highlightedShop;
                const isMaxAvg = showAverage && shop === maxAvgShop;
                const el = document.createElement('div');
                let bgColor = isUpdated ? 'bg-sky-200 animate-pulse' : 'bg-white';
                if (isMaxAvg) bgColor = 'bg-green-200';
                
                let content = `<div class="font-semibold text-left">${shop}</div>
                               <div class="text-right">
                                 <span>Bills: ${data.count}</span> | 
                                 <span>Total: ₹${data.revenue.toLocaleString()}</span>
                               </div>`;
                if(showAverage) {
                    const avg = (data.revenue / data.count).toFixed(2);
                    content += `<div class="w-full text-right font-bold text-green-700">Avg: ₹${avg}</div>`;
                }

                el.className = `p-2 rounded shadow-sm flex flex-wrap justify-between items-center ${bgColor}`;
                el.innerHTML = content;
                shopCountsContainer.appendChild(el);
                if(isUpdated) setTimeout(() => el.classList.remove('animate-pulse'), 900);
            });
        }

        startSimBtn.addEventListener('click', () => {
            startSimBtn.disabled = true;
            let billIndex = 0;
            let shopData = {};
            let maxRevenue = 0;
            let maxRevenueShop = 'None';
            shopCountsContainer.innerHTML = '';

            simInterval = setInterval(() => {
                if (billIndex >= bills.length) {
                    clearInterval(simInterval);
                    simStatus.textContent = `Iteration complete! Calculating averages...`;
                    renderShopData(shopData, null, true);
                    startSimBtn.disabled = false;
                    return;
                }

                const bill = bills[billIndex];
                currentBillShopEl.textContent = bill.shop;
                currentBillAmountEl.textContent = `₹${bill.amount}`;
                simStatus.textContent = `Processing bill from ${bill.shop}...`;

                if (!shopData[bill.shop]) {
                    shopData[bill.shop] = { count: 0, revenue: 0 };
                }
                shopData[bill.shop].count++;
                shopData[bill.shop].revenue += bill.amount;
                
                if (shopData[bill.shop].revenue > maxRevenue) {
                    maxRevenue = shopData[bill.shop].revenue;
                    maxRevenueShop = bill.shop;
                    maxRevenueShopEl.textContent = maxRevenueShop;
                    maxRevenueValueEl.textContent = `₹${maxRevenue.toLocaleString()}`;
                }

                renderShopData(shopData, bill.shop);

                billIndex++;
            }, 1200);
        });

        resetSimBtn.addEventListener('click', resetSimulator);
        resetSimulator();
        
        // --- Quiz Logic ---
        const quizContainer = document.getElementById('quiz-container');
        const quizData = [
            // From AQ2_5.docx
            {
                question: "Which expression gives the average revenue generated by all shops put together?",
                options: [
                    "SV / SVcount + SG / SGcount + BB / BBcount",
                    "(SV + SG + BB) / (SVcount + SGcount + BBcount)"
                ],
                correct: ["(SV + SG + BB) / (SVcount + SGcount + BBcount)"],
                type: "single",
                explanation: "To find the overall average, you must sum all revenues first, then sum all bill counts, and finally divide the total revenue by the total count."
            },
            {
                question: "The variable `avg` stores the average revenue for all shops. Which expression checks if SV Stores' average is more than the overall average?",
                options: ["SV > avg", "avg < SV / SVcount"],
                correct: ["avg < SV / SVcount"],
                type: "single",
                explanation: "You must calculate the average for SV Stores (SV / SVcount) and then compare it to the overall average (`avg`)."
            },
            {
                question: "Let `SVavg`, `SGavg`, and `BBavg` be the average revenues for the three shops. How many pairwise comparisons are needed to find the shop with the maximum average?",
                options: ["1", "2", "3"],
                correct: ["2"],
                type: "single",
                explanation: "You can find the maximum of three numbers with just two comparisons. For example: compare SVavg and SGavg to find a temporary max, then compare that temporary max with BBavg."
            },
            // New questions
             {
                question: "Why is it generally necessary to finish the entire iteration before you can reliably determine the shop with the highest *average* bill?",
                options: [
                    "Because the last bill processed might belong to the winning shop.",
                    "Because a shop's average can change with every new bill, and you need the final totals for an accurate calculation.",
                    "Because you don't know how many shops there are until the end.",
                    "It's not necessary; you can calculate it during the iteration."
                ],
                correct: ["Because a shop's average can change with every new bill, and you need the final totals for an accurate calculation."],
                type: "single",
                explanation: "A shop's average is a derived metric that depends on its *final* total revenue and *final* bill count. These final values are only known after all bills have been processed."
            },
            {
                question: "During a single iteration, which of these can be accurately tracked in real-time?",
                options: [
                    "The shop with the highest average revenue per bill.",
                    "The final number of bills for every shop.",
                    "The shop with the highest total revenue so far.",
                    "The overall average revenue across all shops."
                ],
                correct: ["The shop with the highest total revenue so far."],
                type: "single",
                explanation: "Total revenue is a simple sum that can be updated with each card. All the other metrics require the full dataset to be processed before they can be accurately calculated."
            }
        ];

        function buildQuiz() {
            quizContainer.innerHTML = '';
            quizData.forEach((q, index) => {
                const optionsHtml = q.options.map(option => `
                    <label class="quiz-option block p-3 border-2 border-slate-200 rounded-lg hover:bg-sky-50 cursor-pointer transition-colors">
                        <input type="radio" name="q${index}" value="${option}" class="mr-3">
                        ${option}
                    </label>
                `).join('');
                const questionHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <p class="text-lg font-semibold mb-4">${index + 1}. ${q.question}</p>
                        <div class="space-y-3" id="q${index}-options">${optionsHtml}</div>
                        <div id="feedback-${index}" class="feedback"></div>
                    </div>
                `;
                quizContainer.innerHTML += questionHtml;
            });
            quizData.forEach((q, index) => {
                document.getElementById(`q${index}-options`).addEventListener('change', () => handleAnswer(q, index));
            });
        }

        function handleAnswer(questionData, questionIndex) {
            const feedbackEl = document.getElementById(`feedback-${questionIndex}`);
            const inputs = document.querySelectorAll(`input[name="q${questionIndex}"]`);
            let selectedAnswers = [];
            inputs.forEach(input => {
                if (input.checked) selectedAnswers.push(input.value);
                input.disabled = true;
            });
            let isCorrect = selectedAnswers.length === 1 && selectedAnswers[0] === questionData.correct[0];
            
            inputs.forEach(input => {
                const label = input.parentElement;
                if (questionData.correct.includes(input.value)) {
                    label.classList.add('correct');
                } else if (input.checked) {
                    label.classList.add('incorrect');
                }
            });

            feedbackEl.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong> ${questionData.explanation}`;
            feedbackEl.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
        }

        buildQuiz();
    </script>
</body>
</html>
